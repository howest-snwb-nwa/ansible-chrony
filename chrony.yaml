---
# Exercise: add chrony and configure with NTP server of choice
#
# TODO: Change settings to that ntp_server is the ONLY used server
#   - remove existing NTP server
# TODO: Ensure nodes can use different NTP servers, based on their group
# TODO: Ensure a default setting when the admin forgets to set ntp_server

- name: Chrony configuration.
  gather_facts: true                                # Standaard configuratie is 'true'
  hosts: howest_proxmox:!panoramix.snwb.howest.be   # Proxmox 7 servers - remote lab
  vars:
    ntp_server: ntp.telenet.be

  handlers:
  - name: reload sources
    ansible.builtin.command: /usr/bin/chronyc reload sources

  tasks:
  - name: Ensure chrony is installed.
    ansible.builtin.package:
      name: chrony
      state: present

  - name: Show chosen NTP server.
    ansible.builtin.debug:
      msg: "NTP server will be {{ ntp_server }}."

  - name: Add time source.
    ansible.builtin.copy:
      content: |
        server {{ ntp_server }} iburst
      dest: /etc/chrony/sources.d/local.sources
      owner: root
      group: root
      mode: '0644'
    notify: reload sources

  - name: Ensure chrony is enabled.
    ansible.builtin.service:
      name: chronyd.service
      enabled: true                                 # Enable at boot
      state: started                                # Ensure chrony is running now

